#!/bin/sh
set -e

export PATH="/root/.local/bin:/root/.cargo/bin:$HOME/.local/bin:$HOME/.cargo/bin:/usr/local/bin:$PATH"

case "$1" in
configure)
	# Remove old /opt installation (migration from 2.1.x)
	[ -d /opt/distiller-update ] && rm -rf /opt/distiller-update
	[ -f usr/bin/distiller-update ] && rm -f usr/bin/distiller-update

	cd /usr/lib/distiller-update

	# Install as system tool using uv
	echo "INFO: Installing distiller-update with uv tool..."
	uv tool install --editable . || {
		echo "ERROR: Failed to install distiller-update"
		exit 1
	}

	# Ensure cache directory exists with proper permissions
	mkdir -p /var/cache/distiller-update
	chmod 755 /var/cache/distiller-update

	echo "INFO: distiller-update installed successfully."
	echo "INFO: Start service: sudo systemctl start distiller-update.timer"
	;;

abort-upgrade | abort-remove | abort-deconfigure) ;;

*)
	echo "postinst called with unknown argument \`$1'" >&2
	exit 1
	;;
esac

#DEBHELPER#

exit 0
