#!/bin/sh
set -e

case "$1" in
configure)
	cd /usr/lib/distiller-update

	if [ ! -d .venv ]; then
		uv venv || {
			echo "ERROR: Failed to create virtual environment" >&2
			exit 1
		}
	fi

	# Enable bytecode compilation for faster startup
	export UV_COMPILE_BYTECODE=1
	export UV_LINK_MODE=copy

	# Install the package
	uv pip install --python .venv/bin/python --compile-bytecode . || {
		echo "ERROR: Failed to install package" >&2
		exit 1
	}

	# Ensure cache directory exists with proper permissions
	mkdir -p /var/cache/distiller-update
	chmod 755 /var/cache/distiller-update

	echo "INFO: distiller-update installed successfully."
	echo "INFO: Start service: sudo systemctl start distiller-update.timer"
	;;

abort-upgrade | abort-remove | abort-deconfigure) ;;

*)
	echo "ERROR: postinst called with unknown argument \`$1'" >&2
	exit 1
	;;
esac

#DEBHELPER#

exit 0
